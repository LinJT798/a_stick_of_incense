# 一炷香 - 游戏设计文档

## 游戏概述
"一炷香"是一款融合中国传统文化元素的躲避类网页游戏。玩家需要操控角色躲避四面八方射来的箭矢，以"香"作为时间单位（10秒=一炷香），挑战自己能坚持多少炷香。

## 技术信息
- **开发框架**：Phaser
- **平台**：PC端网页游戏
- **控制方式**：WASD或方向键

## 游戏流程
```
进入首页 --> 点击首页按钮 --> 进入主场景 --> 3、2、1倒计时 --> 游戏进行中
                                                               ↓
                                                          玩家失败
                                                               ↓
结算界面 <────────────── 点击重新开始按钮 ──────────────────── 结算界面
```

## 场景设计

### 1. 首页场景
- 包含游戏标题和"开始游戏"按钮
- 点击按钮进入主场景
- **场景大小**：1512 × 982 像素
- **坐标系**：以组件左上角为原点的绝对坐标

**组件布局**（层级从低到高）：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)
   - 层级：0

2. **标题图** (`img_title`)
   - 显示大小：801 × 446
   - 位置：(355, 153)
   - 层级：1

3. **装饰图1** (`img_decor_1`)
   - 显示大小：244 × 204
   - 位置：(999, 376)
   - 层级：2

4. **装饰图2** (`img_decor_2`)
   - 显示大小：268 × 268
   - 位置：(466, 580)
   - 层级：3

5. **按钮图片** (`btn_start`)
   - 显示大小：218 × 145
   - 位置：(647, 660)
   - 层级：4

注：所有资源需要缩放到指定的显示大小

### 2. 主游戏场景
- **场景大小**：1512 × 982 像素
- **布局**：左侧为躲避区域，右侧为香炉计时区
- **游戏开始前**：
  - 直接显示3、2、1倒计时
- **游戏进行中**：
  - 玩家控制角色在躲避区域内移动
  - 箭矢从各个方向射向玩家
  - 香炉播放燃烧动画，每10秒完成一炷香
  - 显示当前是第几炷香

**组件布局**：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)

2. **香炉** (`sprite_incense`)
   - 显示大小：435 × 435
   - 位置：(1097, 197)
   - 说明：此位置播放香炉精灵动画，动画资源需缩放到435×435尺寸
   - 动画：每10秒完成一个循环，代表一炷香

3. **场地** (`img_field`)
   - 显示大小：1031 × 909.96
   - 位置：(78, 12.04)

4. **活动范围** (`area_bounds`)
   - 椭圆尺寸：698.14 × 620.33（宽×高）
   - 中心位置：(596.74, 471.345)（计算：x = 247.67 + 698.14/2, y = 161.18 + 620.33/2）
   - 形状：椭圆形
   - 说明：玩家可移动的椭圆形区域边界

5. **主角** (`player`)
   - 显示大小：92 × 83
   - 初始位置：(551, 418)

6. **箭矢** (`arrow`)（示例）
   - 显示大小：83 × 24
   - 位置：动态生成

7. **装饰叶子** (`leaf`)
   - 显示大小：38 × 32
   - 位置：动态生成
   - 效果：叶子飘落动画
     - 从屏幕顶部随机位置生成
     - 以不同速度缓慢飘落
     - 带有轻微左右摇摆效果
     - 可能有轻微旋转
     - 到达屏幕底部后消失并重新生成

8. **香数显示** (`text_incense_count`)
   - 显示大小：78 × 59
   - 位置：(1276, 613)
   - 字体：Chicle, 64px
   - 颜色：#000000
   - 内容：显示当前是第几炷香（如"三"、"四"等）

### 3. 结算界面
- **场景大小**：1512 × 982 像素
- 显示玩家坚持了多少炷香
- 包含"重新开始"按钮
- 点击后直接返回倒计时

**组件布局**：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)

2. **装饰图1** (`img_decor_1`)
   - 显示大小：475 × 397
   - 位置：(121, 213)

3. **装饰图2** (`img_decor_2`)
   - 显示大小：401 × 401
   - 位置：(620, 149)

4. **结果文本** (`text_result`)
   - 显示大小：268 × 59
   - 位置：(988, 412)
   - 字体：Chicle, 64px
   - 颜色：#000000
   - 内容：显示"X炷香"（如"三炷香"）

5. **装饰图3** (`img_decor_3`)
   - 显示大小：268 × 268
   - 位置：(723, 610)

6. **重新开始按钮** (`btn_restart`)
   - 显示大小：218 × 145
   - 位置：(904, 690)

## 游戏机制

### 角色控制
- 使用WASD或方向键移动
- 角色有完整的碰撞体积
- 移动范围限制在**椭圆形活动范围**内
  - 椭圆尺寸：698.14 × 620.33
  - 椭圆中心：(596.74, 471.345)
- 与椭圆边界碰撞时完全阻挡，使用椭圆碰撞检测算法

### 箭矢系统

#### 核心机制
- 一旦箭矢碰到角色，游戏结束
- 固定物理帧更新，使用对象池管理箭矢创建/回收
- 执行流程：Spawn → Simulate → Collision → Reclaim → Director反馈

#### 难度曲线
**发射率**：λ(t) = L0 + a·t + b·log(1+t)
**箭速**：v(t) = clamp(v0 + c·√t, v0, vMax)
**读条时间**：随难度递减（如160ms → 80ms）

#### 生成机制

**1. 时间调度**
- 配额累积：每帧 budget += λ(t)*dt
- 当 budget ≥ 1 时生成一支箭并减1
- 发射时刻添加0-30ms随机抖动

**2. 位置生成**
- 四边按权重随机选择
- 限制同边最大连发次数
- 在选定边均匀采样出生点
- 避开角落（≥24px）
- 允许边外偏移（约16px）

**3. 目标与方向**
- 以玩家当前位置为基准
- 添加少量噪声（高斯/均匀分布）
- 中后期可加入线性预判（根据玩家速度与距离估算提前量）

**4. 读条与发射**
- 生成后进入preDelay阶段
- 到时赋速：vel = dir * v(t)
- 波段首支显示读条，后续可直接发射

#### 模式系统
- **基础模式**：Volley(扇射) / Cross(对射) / Stream(短流)
- **状态切换**：Calm → Build → Peak → Recover
- 控制强弱起伏与可读性

#### 公平性保障

**1. 时间下限**
- 计算最短命中时间 TTC_min
- 要求 TTC_min ≥ t_floor（约0.30s）

**2. 安全区域**
- 玩家周围rSafe（约80px）内
- 禁止在t_floor内可命中的射线

**3. 反夹杀机制**
- 同帧多箭避免无解收敛
- 与近200ms同边箭方向夹角过小则强制偏转
- 不通过则重采样，多次失败则跳过或降低强度

#### 运动与碰撞

**运动**
- 直线运动，到屏外带裕量即回收
- 可扩展分裂/弱追踪但限制角速度

**碰撞检测**
- 玩家碰撞模型：圆形，半径35像素（显示尺寸92×83的内接圆）
- 箭矢碰撞模型：线段，长度70像素（根据箭矢实际角度计算头尾位置）
- 碰撞算法：计算玩家圆心到箭矢线段的最短距离
  - 如果距离 < 玩家半径（35px），则判定为碰撞
  - 使用点到线段距离公式，考虑线段端点情况
- 判定特点：
  - 玩家判定略小于美术表现，保证"擦弹感"
  - 箭矢无论角度如何都能准确判定
  - 避免了旋转矩形碰撞的不准确问题

#### 导演系统
- 统计最近2-3秒的最小TTC和险境次数
- 动态调节下一波的发射率或模式强度
- 形成"紧张-呼吸"的节奏

#### 设计目标
- **高压但公平**：任何命中前都有≥0.3s反应窗，无"无解墙杀"
- **可读节奏**：通过模式组合让通道可见，峰值后给予喘息
- **随机不混乱**：整体如雨点但始终留缝，技术提升明显优于运气
- **流畅稳定**：对象池+宽相位保证高密度下稳定帧率

### 计时系统
- 使用香炉动画作为视觉计时器
- 每炷香持续10秒
- 香炉精灵表参数：
  - 总共100帧（10秒，10fps）
  - 单帧尺寸：512×512像素
  - 精灵表布局：6行×17列
  - 完整图片：8704×3072像素
  - 显示时缩放至435×435

## 资源文件结构

### 目录结构
```
assets/
├── images/
│   ├── backgrounds/
│   │   └── bg_main.png              # 主背景图（1512×982）
│   ├── ui/
│   │   ├── img_title.png            # 游戏标题（801×446）
│   │   ├── btn_start.png            # 开始按钮（218×145）
│   │   └── btn_restart.png          # 重新开始按钮（218×145）
│   ├── decorations/
│   │   ├── img_decor_1.png          # 装饰图1（首页：244×204，结算：475×397）
│   │   ├── img_decor_2.png          # 装饰图2（首页：268×268，结算：401×401）
│   │   ├── img_decor_3.png          # 装饰图3（结算：268×268）
│   │   └── leaf.png                 # 飘落叶子（38×32）
│   ├── gameplay/
│   │   ├── img_field.png            # 场地图（1031×909.96）
│   │   ├── player.png               # 玩家角色（92×83）
│   │   └── arrow.png                # 箭矢（83×24）
│   └── sprites/
│       └── incense_spritesheet.png  # 香炉精灵表
│                                     # 原始尺寸：8704×3072像素（102格，使用前100帧）
│                                     # 单帧：512×512，排布：6行×17列
│                                     # 使用时缩放到435×435
├── audio/
│   └── bgm/
│       └── main_bgm.mp3             # 主背景音乐（没有也可以）
└── fonts/
    └── MFYiBi_Noncommercial-Regular.ttf         # Chicle字体文件
```

### 资源键名映射
```javascript
// 图片资源
'bg_main'           // 背景图
'img_title'         // 标题图
'btn_start'         // 开始按钮
'btn_restart'       // 重新开始按钮
'img_decor_1'       // 装饰1
'img_decor_2'       // 装饰2
'img_decor_3'       // 装饰3
'img_field'         // 场地
'player'            // 玩家
'arrow'             // 箭矢
'leaf'              // 叶子
'incense_sprite'    // 香炉精灵表

// 音频资源
'bgm_main'          // 背景音乐
```

## 技术要点
- 不需要考虑美术风格，使用提供的资源即可
- 暂无难度选择和技能系统
- 专注于核心玩法的实现