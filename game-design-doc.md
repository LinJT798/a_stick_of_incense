# 一炷香 - 游戏设计文档

## 游戏概述
"一炷香"是一款融合中国传统文化元素的躲避类网页游戏。玩家需要操控角色躲避四面八方射来的箭矢，以"香"作为时间单位（10秒=一炷香），挑战自己能坚持多少炷香。

## 技术信息
- **开发框架**：Phaser 3
- **平台**：PC端网页游戏
- **控制方式**：WASD或方向键
- **游戏分辨率**：1512 × 982 像素
- **最大缩放**：85%（1285 × 835 像素）

## 游戏流程
```
进入首页 --> 点击首页按钮 --> 进入介绍场景 --> 点击继续按钮 --> 进入主场景 --> 3、2、1倒计时 --> 游戏进行中
                                                                                              ↓
                                                                                         玩家失败
                                                                                              ↓
                                   结算界面 <──────────── 点击重新开始按钮 ──────────────── 结算界面
```

## 场景设计

### 0. 加载场景
- **场景说明**：游戏资源加载界面
- **场景大小**：1512 × 982 像素
- **背景颜色**：黑色 (#000000)

**组件布局**：
1. **进度条背景框**
   - 颜色：深灰色 (#222222)
   - 位置：(456, 450)
   - 大小：600 × 50
   
2. **进度条**
   - 颜色：绿色 (#4CAF50)
   - 位置：(466, 460)
   - 大小：580 × 30（根据进度动态调整宽度）
   
3. **加载文字**
   - 内容："加载中..."
   - 位置：(756, 430) - 进度条上方
   - 字体：GameFont, 24px
   - 颜色：白色
   
4. **百分比文字**
   - 内容：显示加载百分比
   - 位置：(756, 475) - 进度条中心
   - 字体：Arial, 20px
   - 颜色：白色

### 1. 首页场景
- 包含游戏标题和"开始游戏"按钮
- 点击按钮进入主场景
- **场景大小**：1512 × 982 像素
- **坐标系**：以组件左上角为原点的绝对坐标

**组件布局**（层级从低到高）：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)
   - 层级：0

2. **标题图** (`img_title`)
   - 显示大小：801 × 446
   - 位置：(355, 153)
   - 层级：1

3. **装饰图1** (`img_decor_1`)
   - 显示大小：244 × 204
   - 位置：(999, 376)
   - 层级：2

4. **装饰图2** (`img_decor_2`)
   - 显示大小：268 × 268
   - 位置：(466, 580)
   - 层级：3

5. **按钮图片** (`btn_start`)
   - 显示大小：218 × 145
   - 位置：(647, 660)
   - 层级：4

注：所有资源需要缩放到指定的显示大小

### 2. 介绍场景
- **场景说明**：作为游戏教程和氛围过渡，只能从首页进入
- **场景大小**：1512 × 982 像素
- **坐标系**：以组件左上角为原点的绝对坐标

**组件布局**（层级从低到高）：
1. **背景图** (`bg_intro`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)
   - 层级：0

2. **继续按钮组** (整体作为一个可交互单元)
   - **按钮背景** (`rect_continue`)
     - 显示大小：158 × 52
     - 位置：(1241, 83)
     - 颜色：#F3ECDF
     - 层级：1
   
   - **按钮文字** (`text_continue`)
     - 文字内容："继续"
     - 字体：GameFont（造字工房逸笔体）
     - 字号：48px
     - 颜色：#000000
     - 位置：(1289, 73)
     - 层级：2
   
   - **装饰图** (`img_intro_decor`)
     - 显示大小：115 × 96
     - 位置：(1183, 61)
     - 层级：3（最高层级）
   
   - **交互说明**：
     - 整个按钮组作为一个整体响应点击
     - 使用容器中心点进行缩放，确保从中心缩放
     - 悬停时所有元素一起放大1.02倍
     - 点击时所有元素一起缩小至0.98倍
     - 点击后进入主游戏场景

### 3. 主游戏场景
- **场景大小**：1512 × 982 像素
- **布局**：左侧为躲避区域，右侧为香炉计时区
- **游戏开始前**：
  - **倒计时系统**：
    - 显示内容：中文数字 "三"、"二"、"一"
    - 位置：(756, 491) - 屏幕中心
    - 字体：GameFont, 120px
    - 颜色：黑色 (#000000)，白色描边（3px）
    - **动画效果**：
      - 初始缩放：1.5倍
      - 结束缩放：1倍
      - 透明度：1 → 0
      - 动画时长：900ms
      - 间隔时间：1000ms
- **游戏进行中**：
  - 玩家控制角色在躲避区域内移动
  - 箭矢从各个方向射向玩家
  - 香炉播放燃烧动画，每10秒完成一炷香
  - 显示当前是第几炷香

**组件布局**：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)

2. **香炉** (`sprite_incense`)
   - 显示大小：435 × 435
   - 位置：(1097, 197)
   - 说明：此位置播放香炉精灵动画，动画资源需缩放到435×435尺寸
   - 动画：每10秒完成一个循环，代表一炷香

3. **场地** (`img_field`)
   - 显示大小：1031 × 909.96
   - 位置：(78, 12.04)

4. **活动范围** (`area_bounds`)
   - 椭圆尺寸：698.14 × 620.33（宽×高）
   - 中心位置：(596.74, 471.345)（计算：x = 247.67 + 698.14/2, y = 161.18 + 620.33/2）
   - 形状：椭圆形
   - 说明：玩家可移动的椭圆形区域边界

5. **主角** (`player`)
   - 显示大小：92 × 83
   - 初始位置：(551, 418)

6. **箭矢** (`arrow`)（示例）
   - 显示大小：83 × 24
   - 位置：动态生成

7. **装饰叶子** (`leaf`)
   - 显示大小：38 × 32
   - 数量：10片
   - 初始位置：屏幕顶部随机位置（y: -50 到 -550）
   - 效果：叶子飘落动画
     - **下落速度**：30-50 像素/秒（随机）
     - **摇摆幅度**：30-50 像素（随机）
     - **摇摆速度**：1-1.5（随机）
     - **运动算法**：
       - 垂直运动：匀速下落
       - 水平运动：基于正弦函数的摇摆 `x = initialX + sin(time) * swayAmount`
       - 旋转效果：`rotation = sin(time) * 0.2`
     - **循环机制**：到达屏幕底部（y > 1032）后重置到顶部

8. **香数显示** (`text_incense_count`)
   - 显示大小：78 × 59
   - 位置：(1276, 613)
   - 字体：Chicle, 64px
   - 颜色：#000000
   - 内容：显示当前是第几炷香（如"三"、"四"等）

### 4. 结算界面
- **场景大小**：1512 × 982 像素
- 显示玩家坚持了多少炷香
- 包含"重新开始"按钮
- 点击后直接返回倒计时

**组件布局**：
1. **背景图** (`bg_main`)
   - 显示大小：1512 × 982
   - 位置：(0, 0)

2. **装饰图1** (`img_decor_1`)
   - 显示大小：475 × 397
   - 位置：(121, 213)

3. **装饰图2** (`img_decor_2`)
   - 显示大小：401 × 401
   - 位置：(620, 149)

4. **结果文本** (`text_result`)
   - 显示大小：268 × 59
   - 位置：(988, 412)
   - 字体：Chicle, 64px
   - 颜色：#000000
   - 内容：显示"X炷香"（如"三炷香"）

5. **装饰图3** (`img_decor_3`)
   - 显示大小：268 × 268
   - 位置：(723, 610)

6. **重新开始按钮** (`btn_restart`)
   - 显示大小：218 × 145
   - 位置：(904, 690)

## 交互设计规范

### 按钮交互
- **实现方式**：
  - 图片按钮使用 `setDisplaySize` 基于显示尺寸缩放
  - 组合按钮使用容器（Container）统一管理缩放
  - 所有按钮设置中心点（origin 0.5, 0.5）确保中心缩放
- **交互区域**：
  - 使用透明矩形定义可点击区域
  - 启用手型光标 (`useHandCursor: true`)
- **悬停效果**：
  - 缩放至1.02倍
  - 添加淡黄色调（0xffffcc）
- **点击效果**：
  - 缩放至0.98倍
- **释放效果**：
  - 恢复原始大小和颜色
  - 触发场景跳转或功能

## 游戏机制

### 角色控制
- 使用WASD或方向键移动
- 角色有完整的碰撞体积
- **移动范围限制**：椭圆形活动范围
  - 椭圆尺寸：698.14 × 620.33
  - 椭圆中心：(596.74, 471.345)
  - **椭圆约束算法**：
    ```
    1. 计算玩家相对椭圆中心的位置 (dx, dy)
    2. 归一化到单位圆：nx = dx/a, ny = dy/b
    3. 计算距离：distance = sqrt(nx² + ny²)
    4. 如果 distance > 0.95（边界裕量）：
       - 限制到边界：scale = 0.95 / distance
       - 新位置：x = centerX + dx * scale, y = centerY + dy * scale
    ```
- 与椭圆边界碰撞时完全阻挡，使用椭圆碰撞检测算法

### 箭矢系统

#### 高级生成特性

**边缘选择算法**
- 基础四边权重：[1, 1, 1, 1]（上下左右）
- **动态权重调整**：根据玩家位置增加对面边的权重
  ```
  if (player.x < 400) weights[right] *= 1.5
  if (player.x > 800) weights[left] *= 1.5
  if (player.y < 300) weights[bottom] *= 1.5
  if (player.y > 600) weights[top] *= 1.5
  ```
- 使用权重随机算法选择生成边

**特殊模式**
- **扇射模式**（Peak模式下30%概率）：
  - 同时生成3支箭
  - 中心箭指向玩家
  - 两侧箭偏移±15度
  - 速度为正常速度的90%
  
**导演系统**
- 记录最近20次箭矢的TTC（Time To Collision）
- 计算平均TTC调整危险等级：
  - TTC < 0.5秒：危险等级+0.01
  - TTC > 1.0秒：危险等级-0.01
- 危险等级影响生成率：`rate *= (1 - dangerLevel * 0.2)`

**对象池管理**
- 最大箭矢数量：100
- 超出屏幕边界100像素后回收
- 预创建所有箭矢对象，避免运行时创建

### 箭矢系统（原有内容）

#### 核心机制
- 一旦箭矢碰到角色，游戏结束
- 固定物理帧更新，使用对象池管理箭矢创建/回收
- 执行流程：Spawn → Simulate → Collision → Reclaim → Director反馈

#### 难度曲线
**发射率**：λ(t) = L0 + a·t + b·log(1+t)
**箭速**：v(t) = clamp(v0 + c·√t, v0, vMax)
**读条时间**：随难度递减（如160ms → 80ms）

#### 生成机制

**1. 时间调度**
- 配额累积：每帧 budget += λ(t)*dt
- 当 budget ≥ 1 时生成一支箭并减1
- 发射时刻添加0-30ms随机抖动

**2. 位置生成**
- 四边按权重随机选择
- 限制同边最大连发次数
- 在选定边均匀采样出生点
- 避开角落（≥24px）
- 允许边外偏移（约16px）

**3. 目标与方向**
- 以玩家当前位置为基准
- 添加少量噪声（高斯/均匀分布）
- 中后期可加入线性预判（根据玩家速度与距离估算提前量）

**4. 读条与发射**
- 生成后进入preDelay阶段
- 到时赋速：vel = dir * v(t)
- 波段首支显示读条，后续可直接发射

#### 模式系统
- **基础模式**：Volley(扇射) / Cross(对射) / Stream(短流)
- **状态切换**：Calm → Build → Peak → Recover
- 控制强弱起伏与可读性

#### 公平性保障

**1. 时间下限**
- 计算最短命中时间 TTC_min
- 要求 TTC_min ≥ t_floor（约0.30s）

**2. 安全区域**
- 玩家周围rSafe（约80px）内
- 禁止在t_floor内可命中的射线

**3. 反夹杀机制**
- 同帧多箭避免无解收敛
- 与近200ms同边箭方向夹角过小则强制偏转
- 不通过则重采样，多次失败则跳过或降低强度

#### 运动与碰撞

**运动**
- 直线运动，到屏外带裕量即回收
- 可扩展分裂/弱追踪但限制角速度

**碰撞检测**
- **玩家碰撞模型**：
  - 形状：圆形
  - 半径：35像素（显示尺寸92×83的内接圆）
  - 物理体：80×70（略小于显示尺寸，增强"擦弹感"）
  
- **箭矢碰撞模型**：
  - 形状：线段
  - 长度：70像素
  - 计算方式：基于箭矢中心点和旋转角度计算头尾位置
    ```
    tailX = arrow.x - cos(angle) * 35
    tailY = arrow.y - sin(angle) * 35
    headX = arrow.x + cos(angle) * 35
    headY = arrow.y + sin(angle) * 35
    ```
  
- **碰撞算法**：点到线段最短距离算法
  ```
  1. 计算点到线段的投影参数 t = dot(AP, AB) / |AB|²
  2. 限制 t 在 [0,1] 范围内（处理端点情况）
  3. 计算最近点：P = A + t * AB
  4. 返回点到最近点的距离
  5. 如果距离 < 35像素，判定为碰撞
  ```

#### 导演系统
- 统计最近2-3秒的最小TTC和险境次数
- 动态调节下一波的发射率或模式强度
- 形成"紧张-呼吸"的节奏

#### 设计目标
- **高压但公平**：任何命中前都有≥0.3s反应窗，无"无解墙杀"
- **可读节奏**：通过模式组合让通道可见，峰值后给予喘息
- **随机不混乱**：整体如雨点但始终留缝，技术提升明显优于运气
- **流畅稳定**：对象池+宽相位保证高密度下稳定帧率

### 计时系统
- 使用香炉动画作为视觉计时器
- 每炷香持续10秒
- 香炉精灵表参数：
  - 总共100帧（10秒，10fps）
  - 单帧尺寸：512×512像素
  - 精灵表布局：6行×17列
  - 完整图片：8704×3072像素
  - 显示时缩放至435×435
- **中文数字转换**：
  - 0-10：零、一、二、三、四、五、六、七、八、九、十
  - 11-19：十一、十二...十九
  - 20-99：二十、二十一...九十九
  - 100+：一百、一百零一...九百九十九

## 难度配置系统

### 配置参数（可调整）

**生成频率参数**
- `baseSpawnRate`: 0.3 箭/秒（初始生成率）
- `spawnRateGrowth`: 0.025（线性增长率）
- `spawnRateLogGrowth`: 0.10（对数增长率）
- 计算公式：`rate = base + growth * t + logGrowth * log(1 + t)`

**箭矢速度参数**
- `baseSpeed`: 300 像素/秒（初始速度）
- `maxSpeed`: 600 像素/秒（最大速度）
- `speedGrowth`: 10（速度增长率）
- 计算公式：`speed = min(baseSpeed + speedGrowth * sqrt(t), maxSpeed)`

**公平性参数**
- `minTTC`: 0.5 秒（最小反应时间）
- `safeRadius`: 100 像素（安全半径）
- `preDelay`: 200 毫秒（读条时间）

**模式倍率**
- calm（平静）: 0.5倍
- build（上升）: 0.8倍
- peak（高峰）: 1.2倍
- recover（恢复）: 0.6倍

**模式时长**
- calm: 5秒
- build: 8秒
- peak: 10秒
- recover: 4秒

### 配置文件
- 位置：`src/config/DifficultyConfig.js`
- 支持运行时修改参数
- 所有参数集中管理，方便调试

## 资源文件结构

### 目录结构
```
assets/
├── images/
│   ├── backgrounds/
│   │   ├── bg_main.png              # 主背景图（1512×982）
│   │   └── bg_intro.png             # 介绍场景背景图（1512×982）
│   ├── ui/
│   │   ├── img_title.png            # 游戏标题（801×446）
│   │   ├── btn_start.png            # 开始按钮（218×145）
│   │   ├── btn_restart.png          # 重新开始按钮（218×145）
│   │   └── img_intro_decor.png      # 介绍场景装饰图（115×96）
│   ├── decorations/
│   │   ├── img_decor_1.png          # 装饰图1（首页：244×204，结算：475×397）
│   │   ├── img_decor_2.png          # 装饰图2（首页：268×268，结算：401×401）
│   │   ├── img_decor_3.png          # 装饰图3（结算：268×268）
│   │   └── leaf.png                 # 飘落叶子（38×32）
│   ├── gameplay/
│   │   ├── img_field.png            # 场地图（1031×909.96）
│   │   ├── player.png               # 玩家角色（92×83）
│   │   └── arrow.png                # 箭矢（83×24）
│   └── sprites/
│       └── incense_spritesheet.png  # 香炉精灵表
│                                     # 原始尺寸：8704×3072像素（102格，使用前100帧）
│                                     # 单帧：512×512，排布：6行×17列
│                                     # 使用时缩放到435×435
├── audio/
│   └── bgm/
│       └── main_bgm.mp3             # 主背景音乐（没有也可以）
└── fonts/
    └── MFYiBi_Noncommercial-Regular.ttf         # 字体文件
```

### 资源键名映射
```javascript
// 图片资源
'bg_main'           // 背景图
'img_title'         // 标题图
'btn_start'         // 开始按钮
'btn_restart'       // 重新开始按钮
'img_decor_1'       // 装饰1
'img_decor_2'       // 装饰2
'img_decor_3'       // 装饰3
'img_field'         // 场地
'player'            // 玩家
'arrow'             // 箭矢
'leaf'              // 叶子
'incense_sprite'    // 香炉精灵表

// 音频资源
'bgm_main'          // 背景音乐
```

## 技术要点
- 不需要考虑美术风格，使用提供的资源即可
- 暂无难度选择和技能系统
- 专注于核心玩法的实现